{% extends "base_generic.html" %}

{% block content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom"
     xmlns:task.done_datetime xmlns:task.done_datetime xmlns:task.done_datetime xmlns:task.done_datetime>
    <h1 class="h2">Baking plan</h1>
</div>

<div class="alert alert-danger hidden" role="alert">
  Updating baking plan failed.
</div>

<div class="alert alert-success hidden" role="alert">
  Updating baking plan successfully.
</div>

<form id="form" method="post">
  {% csrf_token %}
  <div style="width: 100%;">
    <table class="table table-hover table-striped">
      <thread class="table-light">
        <tr class="header">
          <th scope="col" style="width:70%;">Name</th>
          <th scope="col">Quantity West</th>
          <th scope="col">Quantity East</th>
        </tr>
      </thread>
      <tbody>
        {% for product in products %}
        <tr>
          <input type="number" name="product" value="{{product.id}}" style="display: none;" />
          <td class="align-middle">{{ product.name }}</td>
          <td>
            <div style="display: flex; flex-direction: row; gap: 0.5rem;">
              <input name="value" type="text" pattern="[0-9]+([.,][0-9]+)?" inputmode="decimal" class="form-control" id="value" value="" placeholder="10" style="width: 100px;">
              <small class="opacity-50 text-nowrap truncate">
                {{ product.unit.all | join:", " }}
              </small>
            </div>
          </td>
          <td>
            <div style="display: flex; flex-direction: row; gap: 0.5rem;">
              <input name="value" type="text" pattern="[0-9]+([.,][0-9]+)?" inputmode="decimal" class="form-control" id="value" value="" placeholder="10" style="width: 100px;">
              <small class="opacity-50 text-nowrap truncate">
                {{ product.unit.all | join:", " }}
              </small>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <input type="submit" id="submitTasksBtn" class="w-100 btn btn-lg btn-primary" value="Update baking plan" style="max-width: 250px;" />
  </div>
</form>

<style>
  .truncate {
    width: 30px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ".";
  }
  table {
    font-size: 1rem;
  }
  tr.header th {
    color: #495057 !important;
    background-color: #e9ecef;
    border-color: #dee2e6;
  }
  td {
    padding: .9rem .5rem !important;
  }
  td:first-child {
    padding: .9rem .9rem !important;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("form");
    form.addEventListener("submit", onFormSubmit);
    function onFormSubmit() {

      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      var alerts = document.getElementsByClassName("alert");
      for(var i = 0; i < alerts.length; i++) {
        var alert = alerts[i];
        alert.classList.add('hidden');
      }
      var form_data = new FormData(form);

      let objSerializedForm = {};
      // for (let [name, value] of form_data) {
      //   if (name === "product") {
      //     product = value;
      //   }
      //   if (name === "storage") {
      //     storage = value;
      //   }
      //   if (name === "value") {
      //     objSerializedForm[product] = {
      //       storage: storage,
      //       value: value
      //     };
      //   }
      // }

      var request = new XMLHttpRequest();
      request.onreadystatechange = function() {
        if (request.readyState == 4) {
          if(request.status == 200) {
            var element = document.getElementsByClassName("alert-success")[0];
            element.classList.remove("hidden");
            isSubmittedToday = true;
          } else {
            var element = document.getElementsByClassName("alert-danger")[0];
            element.classList.remove("hidden");
          }
          window.scrollTo(0, 0);
        }
      }
      request.open('POST', '/tasks/baking');
      request.setRequestHeader("X-CSRFToken", csrftoken); 
      request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      request.send(JSON.stringify(objSerializedForm));
    }
  })
</script>
{% endblock %}