{% extends "base_generic.html" %}

{% block title %}Welcome{% endblock %}

{% block content %}

<div class="alert alert-success hidden" role="alert">
    Rating submitted successfully.
</div>

<div class="alert alert-danger hidden" role="alert">
    Punching in/out failed.
</div>

<div class="row g-1">
    <div class="col-lg-6 pe-lg-2 mb-3">
        <div class="card h-lg-100 overflow-hidden">
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-0">{% if ongoingShift %} Punch out {% else %} Punch in {% endif %}</h6>
                    </div>
                    <div class="col-auto text-center pe-x1">
                        <br><br>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group w-auto rounded-0">
                    <div class="row align-items-center" style="padding:15px; text-align: center;">
                        {% if ongoingShift %} <span id="clock" style="font-size:2.5rem"></span> {% endif %}
                        <button id="punchShiftButton" type="button" class="btn btn-lg btn-primary">{% if ongoingShift %} Punch out {% else %} Punch in {% endif %}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if showOpening or showClosing %}
    <div class="row g-1">
{% endif %}
{% if showOpening %}
        <div class="col-lg-6 pe-lg-2 mb-3">
            <div class="card h-lg-100 overflow-hidden">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="mb-0">Store Opening</h6>
                        </div>
                        <div class="col-auto text-center pe-x1">
                            <br><br>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group w-auto rounded-0">
                        <label class="list-group-item d-flex gap-3">
                              <span class="pt-1 form-checked-content">
                                  <strong>Reminder:</strong> make sure you completed all the steps.
                              </span>
                        </label>
                    </div>
                </div>

                <div class="card-footer bg-light p-0">
                    <a class="btn btn-sm btn-link d-block w-100 py-2" href="/procedures/opening">See store opening tasks
                        <span class="fas fa-chevron-right ms-1 fs--2"></span>
                    </a>
                </div>
            </div>
        </div>
{% endif %}

{% if showClosing %}
        <div class="col-lg-6 pe-lg-2 mb-3">
            <div class="card h-lg-100 overflow-hidden">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="mb-0">Store Closing</h6>
                        </div>
                        <div class="col-auto text-center pe-x1">
                            <br><br>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group w-auto rounded-0">
                        <label class="list-group-item d-flex gap-3">
                              <span class="pt-1 form-checked-content">
                                  <strong>Reminder:</strong> make sure you completed all the steps.
                              </span>
                        </label>
                    </div>
                </div>

                <div class="card-footer bg-light p-0">
                    <a class="btn btn-sm btn-link d-block w-100 py-2" href="/procedures/closing">See store closing tasks
                        <span class="fas fa-chevron-right ms-1 fs--2"></span>
                    </a>
                </div>
            </div>
        </div>
{% endif %}
{% if showOpening or showClosing %}
    </div>
{% endif %}

<div class="row g-0">

    <div class="col-lg-6 pe-lg-2 mb-3">
        <div class="card h-lg-100 overflow-hidden">
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-0">My Tasks</h6>
                    </div>
                    <div class="col-auto text-center pe-x1">
                        <br><br>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group w-auto rounded-0">
                    {% for task in task_list %}
                        {% if task.date_done == undefined or task.date_done|date:"Y-m-d" != today|date:"Y-m-d" %}
                            <label class="list-group-item d-flex gap-3">
                              <span class="pt-1 form-checked-content">
                                {{ task.title }}
                                <small class="d-block text-muted" style="margin: 0.1rem 0;">
                                  <span data-feather="tag" class="align-text-bottom"></span>
                                  {{ task.get_types|join:", " }},
                                  <span data-feather="user" class="align-text-bottom"></span>
                                  {{ task.assignees }}
                                </small>
                              </span>
                            </label>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="card-footer bg-light p-0">
                    <a class="btn btn-sm btn-link d-block w-100 py-2" href="/tasks">See all tasks
                        <span class="fas fa-chevron-right ms-1 fs--2"></span>
                    </a>
                </div>
            </div>
        </div>
    </div>

     <div class="col-lg-6 pe-lg-2 mb-3">
        <div class="card h-lg-100 overflow-hidden">
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-0">Next Shifts</h6>
                    </div>
                    <div class="col-auto text-center pe-x1">
                        <br><br>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <ul class="shifts">
                    {% for shift in nextShifts %}
                    <li>
                        <div class="date">
                            {{ shift.day }}
                            <span class="weekday">{{ shift.weekday }}</span>
                        </div>
                        <div class="shift">
                            <span class="time">{{ shift.start }} – {{ shift.end }}</span>
                            <span class="location">iaro, Sophienstraße</span>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

    <div class="modal fade modal-tour" tabindex="-1" role="dialog" id="errorModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content rounded-4 shadow">
          <div class="modal-body p-5">
            <h2 class="fw-bold mb-0">Error</h2>
            <br>
            <span class="errorModalContent">Sorry, you forgot to rate your shift.</span>
          </div>
        </div>
      </div>
  </div>

<div class="modal fade modal-tour" tabindex="-1" role="dialog" id="submitModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content rounded-4 shadow">
          <div class="modal-body p-5">
            <h2 class="fw-bold mb-0">{% if ongoingShift %} Submit rating and punch out {% else %} Punch in {% endif %}</h2>
            <br>
              <form id="ratingForm" method="post">
                  {% csrf_token %}
                  <input type="text" name="user" value="{{user.id}}" style="display: none;" />
                  {% if ongoingShift %}
                    <h5>How was todays shift for you?</h5>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="stars">
                                <input class="star star-5" id="star-5" type="radio" name="star" value="5"/>
                                <label class="star star-5" for="star-5"></label>
                                <input class="star star-4" id="star-4" type="radio" name="star" value="4"/>
                                <label class="star star-4" for="star-4"></label>
                                <input class="star star-3" id="star-3" type="radio" name="star" value="3"/>
                                <label class="star star-3" for="star-3"></label>
                                <input class="star star-2" id="star-2" type="radio" name="star" value="2"/>
                                <label class="star star-2" for="star-2"></label>
                                <input class="star star-1" id="star-1" type="radio" name="star" value="1"/>
                                <label class="star star-1" for="star-1"></label>
                            </div>
                        </div>
                    </div>
                  {% endif %}
                <input type="submit" class="w-100 btn btn-lg btn-primary" value="Submit" style="margin-top: 1rem; max-width: 200px;"  data-bs-dismiss="modal"/>
              </form>
          </div>
        </div>
      </div>
  </div>

<style>
  .btn-link {
    text-decoration: none;
  }
  ul.shifts {
    list-style: none;
    padding: 0;
    margin-top: 0.5rem;
  }
  ul.shifts li {
    display: flex;
    align-items: center;
    margin: 0.25rem 1rem 0.25rem 0;
  }
  ul.shifts li .date {
    padding: 1rem;
    font-size: 1.4rem;
    font-weight: 600;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  ul.shifts li .date .weekday {
    font-size: 0.7rem;
    color: #969696;
    font-weight: 600;
    margin-top: -0.4rem;
  }
  ul.shifts li .shift {
    background: #feebef;
    padding: 0.7rem 1.4rem;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    width: 100%;
  }
  ul.shifts li .shift .time {
    font-size: 1rem;
    font-weight: 600;
    color: #d35d7d;
  }
  ul.shifts li .shift .location {
    color: #8a7f82;
  }

    div.stars {
      display: inline-block;
    }

    input.star { display: none; }

    label.star {
      float: right;
      padding: 5px;
      font-size: 36px;
      color: #000000;
      transition: all .2s;
    }

    input.star:checked ~ label.star:before {
      content: '★';
      color: #FD4;
      transition: all .25s;
    }

    input.star-5:checked ~ label.star:before {
      color: #FE7;
      text-shadow: 0 0 5px #952;
    }

    input.star-1:checked ~ label.star:before { color: #F62; }

    label.star:hover { transform: rotate(-15deg) scale(1.3); }

    label.star:before {
      content: '☆';
    }
  </style>
<script>

    function shiftTime() {
        var shiftStart = '{{shiftStart}}';
        var span = document.getElementById('clock');
        var now = new Date();
        var shiftStartDate = new Date(parseFloat(shiftStart)*1000);
        var millis = now - shiftStartDate;
        let h,m,s;
        h = Math.floor(millis/1000/60/60);
        m = Math.floor((millis/1000/60/60 - h)*60);
        s = Math.floor(((millis/1000/60/60 - h)*60 - m)*60);
        s < 10 ? s = '0' + s: s = s
        m < 10 ? m = '0' + m: m = m
        h < 10 ? h = '0' + h: h = h
        span.textContent = h + ":" + m + ":" + s;
    }

    document.addEventListener("DOMContentLoaded", function() {

      var ongoingShift = '{{ongoingShift}}';
      var ongoingShift = (ongoingShift.toLowerCase() === "true");
      if (ongoingShift) {
          shiftTime();
          setInterval(shiftTime, 1000);
      }

      document.getElementById('ratingForm').onsubmit = function (evt) {
        evt.preventDefault();
        var ongoingShift = '{{ongoingShift}}';
        var ongoingShift = (ongoingShift.toLowerCase() === "true");
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          var errorModal = new bootstrap.Modal(document.getElementById("errorModal"), {});
          var submitModal = new bootstrap.Modal(document.getElementById("submitModal"), {});
          var alerts = document.getElementsByClassName("alert");
          for(var i = 0; i < alerts.length; i++) {
            var alert = alerts[i];
            alert.classList.add('hidden');
          }
          var form = document.querySelector('#ratingForm');
          var form_data = new FormData(form);

          let objSerializedForm = {};
          console.log(form_data);
          var star;
          for (let [name, value] of form_data) {
            if (name === "user") {
              userid = value;
            }
            if (name === "star") {
              star = value;
            }
          }
          if (star == null && ongoingShift) {
            submitModal.hide();
            errorModal.show();
            return;
          }
          objSerializedForm[userid] = {'star': star};
          console.log(objSerializedForm);

          var request = new XMLHttpRequest();
          request.onreadystatechange = function() {
            if (request.readyState == XMLHttpRequest.DONE) {
              if(request.status == 200) {
                var element = document.getElementsByClassName("alert-success")[0];
                element.classList.remove("hidden");
                location.reload(); // todo improve
              } else {
                var element = document.getElementsByClassName("alert-danger")[0];
                element.classList.remove("hidden");
              }
            }
            window.scrollTo(0, 0);
          }

          request.open('POST', '/shifts/');
          request.setRequestHeader("X-CSRFToken", csrftoken);
          request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
          request.send(JSON.stringify(objSerializedForm));
          form.reset();
      }

      document.getElementById('punchShiftButton').onclick = function (evt) {
        var submitModal = new bootstrap.Modal(document.getElementById("submitModal"), {});
        submitModal.show();
      }

    });
  </script>

{% load static %}
{% endblock %}
