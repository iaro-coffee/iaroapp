{% extends "base_generic.html" %}

{% block content %}

<div class="list-group w-auto">

  <div class="alert alert-danger hidden" role="alert">
    Submitting the inventory failed.
  </div>

  <div class="alert alert-success hidden" role="alert">
    Inventory submitted successfully.
  </div>

  <div class="page-header">
    <div class="btn-toolbar mb-2 mb-md-0">
      <button type="button" class="btn btn-sm btn-outline-secondary">
        <span data-feather="calendar" class="align-text-bottom"></span>
        Last updated: {{ modifiedDate }}
      </button>
    </div>

    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        {{ branch }}
      </button>
      <ul class="dropdown-menu">
        {% for branch in branches %}
        <li><a class="dropdown-item" href="#">{{ branch }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <form id="form" method="post">
    {% csrf_token %}

    <div class="list-group" id="inventoryList">
    {% for storage in storages %}
        <h4 data-bs-toggle="collapse" href="#collapse{{ storage.name_encoded }}" role="button" class="list-group-item">
          <span class="storage_color" style="background-color:{{ storage.color }};"></span>
          {{ storage.name }}
        </h4>
        <div class="list-group-item collapse" id="collapse{{ storage.name_encoded}}" data-bs-parent="#inventoryList">
          <div class="list-group w-auto">
            {% for product in products %}
              {% if storage in product.storages %}
                <a class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true">
                  <span style="font-size: 2rem">
                    ðŸ“¦
                  </span>
                  <div class="d-flex gap-2 w-100 justify-content-between">
                    <div>
                      <input type="number" name="product" value="{{product.id}}" style="display: none;" />
                      <input type="number" name="storage" value="{{storage.id}}" style="display: none;" />
                      <h6 class="mb-0 wrap">
                        {{ product.name }}
                      </h6>
                      <p class="mb-0 opacity-75">
                      </p>
                    </div>
                    <div style="display: flex; flex-direction: row; gap: 0.5rem;">
                      <input name="value" type="text" pattern="[0-9]+([.,][0-9]+)?" inputmode="decimal" class="form-control" id="value" value="" style="width: 100px;">
                      <small class="opacity-50 text-nowrap truncate">
                        {{ product.unit.all | join:", " }}
                      </small>
                    </div>
                  </div>
                </a>
                {% endif %}
              {% endfor %}
              <input type="submit" class="w-100 btn btn-lg btn-primary" value="Submit inventory" />
            </div>
        </div>
    {% endfor %}
    </div>
  </form>

  <div class="modal fade" id="submitInventoryModal" tabindex="-1" role="dialog" aria-labelledby="submitInventoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="submitInventoryModalLabel">Warning</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Inventory have already been submitted for today. Are you sure you want to update it?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmSubmit">Update inventory</button>
        </div>
      </div>
    </div>
  </div>

  <script>

    var isSubmittedToday = ('{{ isSubmittedToday | safe }}' === 'True');

    function submitForm() {

      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      var alerts = document.getElementsByClassName("alert");
      for(var i = 0; i < alerts.length; i++) {
        var alert = alerts[i];
        alert.classList.add('hidden');
      }      var form = document.querySelector('form');
      var form_data = new FormData(form);

      let objSerializedForm = {};
      for (let [name, value] of form_data) {
        if (name === "product") {
          product = value;
        }
        if (name === "storage") {
          storage = value;
        }
        if (name === "value") {
          objSerializedForm[product] = {
            storage: storage,
            value: value
          };
        }
      }

      var request = new XMLHttpRequest();
      request.onreadystatechange = function() {
        if (request.readyState == 4) {
          if(request.status == 200) {
            var element = document.getElementsByClassName("alert-success")[0];
            element.classList.remove("hidden");
            isSubmittedToday = true;
          } else {
            var element = document.getElementsByClassName("alert-danger")[0];
            element.classList.remove("hidden");
          }
          window.scrollTo(0, 0);
        }
      }
      request.open('POST', '/inventory/All');
      request.setRequestHeader("X-CSRFToken", csrftoken); 
      request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      request.send(JSON.stringify(objSerializedForm));

    }

    document.addEventListener("DOMContentLoaded", function() {

      var submitInventoryModal = new bootstrap.Modal(document.getElementById("submitInventoryModal"), {});

      document.getElementById('confirmSubmit').onclick = function() {
        submitForm();
        submitInventoryModal.hide();
      }

      document.getElementById('form').onsubmit = function (evt) {
      
        evt.preventDefault();

        if (isSubmittedToday) {
          submitInventoryModal.show();
        } else {
          submitForm();
        }

      }

      // Click event handler for dropdown menu selecting branches
      const dropdownItems = document.querySelectorAll('.dropdown-menu .dropdown-item');
      for (const dropdownItem of dropdownItems) {
        dropdownItem.addEventListener('click', (event) => {
          const selectedBranchName = event.target.textContent;
          const url = `/inventory/${selectedBranchName}`;
          window.location.href = url;
        });
      }

      // Colorize fields as "done" for which a value is supplied
      let items = document.querySelectorAll("a.list-group-item");
      items.forEach(item => {
        let input = item.querySelector("input[name='value']");
        input.addEventListener("input", function() {
          if (input.value && input.checkValidity()) {
            item.classList.add('done');
          } else {
            item.classList.remove('done');
          }
        });
      });

    });
  </script>

<style>
  .sticky {
    position: sticky;
    top: 48px;
    z-index: 10;
    background: white;
    margin: -1.5rem;
    padding: 1.5rem 1.5rem 0 1.5rem;
    border-bottom: 1px solid #eef0f2;
  }
  .truncate {
    width: 30px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ".";
  }
  .wrap {
    overflow-wrap: anywhere;
  }

  .page-header {
    width: 100%;
    display: flex;
    margin-bottom: 1rem;
    column-gap: 0.5rem;
    flex-direction: row-reverse;
  }

  .mb-2 {
    margin-bottom: 0rem !important;
  }

  div.list-group-item {
    padding: 0 !important;
  }

  .form-control:invalid {
    color: navy;
    outline: none; 
    border-color: #ff1050;
    box-shadow: 0 0 10px #ff0000;
  }
  .done {
    background-color: rgb(209, 231, 221);
  }

  .list-group-item-action:focus, .list-group-item-action:hover {
    background-color: lightblue !important;
  }

  .storage_color {
    display: block;
    width: 30px;
    height: 50px;
    top: -8px;
    position: relative;
    margin-bottom: -17px;
    left: -16px;
    margin-right: -20px;
    border-radius: 5px 0px;
  }

  h4.list-group-item {
    display: flex;
    gap: 1rem;
  }

  input[type=submit] {
    margin: 0.75rem;
    max-width: 250px;
    align-self: end;
  }

</style>

{% endblock %}