{% extends "base_generic.html" %}

{% block content %}

<div class="list-group w-auto">

  <div class="alert alert-danger hidden" role="alert">
    Submitting the inventory failed.
  </div>

  <div class="alert alert-success hidden" role="alert">
    Inventory submitted successfully.
  </div>

  <form id="form" method="post">
    {% csrf_token %}

    {% for category in categories %}
    
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3">        
        <h1 class="h2">{{ category }}</h1>
        {% if forloop.counter == 1 %}
        <div class="btn-toolbar mb-2 mb-md-0">
          <button type="button" class="btn btn-sm btn-outline-secondary">
            <span data-feather="calendar" class="align-text-bottom"></span>
            Last updated: {{ modifiedDate }}
          </button>
        </div>
        {% endif %}
      </div>

      <div class="list-group w-auto">
        {% for product in products %}
          {% if category in product.category.all %}
            <a class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true">
              <span data-feather="box" style="width: 40px; height: 40px; stroke-width: 1;"></span>
              <div class="d-flex gap-2 w-100 justify-content-between">
                <div>
                  <input type="number" name="product" value="{{product.id}}" style="display: none;" />
                  <h6 class="mb-0">
                    {{ product.name }}
                  </h6>
                  <p class="mb-0 opacity-75">
                  </p>
                </div>
                <div style="display: flex; flex-direction: row; gap: 0.5rem;">
                  <input name="value" type="number" step="0.0" required class="form-control" id="tip" value="0.0" style="max-width: 100px;">
                  <small class="opacity-50 text-nowrap">
                    {{ product.unit.all | join:", " }}
                  </small>
                </div>
              </div>
            </a>
            {% endif %}
          {% endfor %}
        </div>
        <br><br>

    {% endfor %}

    <input type="submit" class="w-100 btn btn-lg btn-outline-primary" value="Submit inventory" style="margin-bottom: 1rem; max-width: 250px;" />
  </form>

  <div class="modal fade" id="submitInventoryModal" tabindex="-1" role="dialog" aria-labelledby="submitInventoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="submitInventoryModalLabel">Warning</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Inventory have already been submitted for today. Are you sure you want to update it?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmSubmit">Update inventory</button>
        </div>
      </div>
    </div>
  </div>

  <script>

    var isSubmittedToday = ('{{ isSubmittedToday | safe }}' === 'True');

    function submitForm() {

      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      var alerts = document.getElementsByClassName("alert");
      for(var i = 0; i < alerts.length; i++) {
        var alert = alerts[i];
        alert.classList.add('hidden');
      }      var form = document.querySelector('form');
      var form_data = new FormData(form);

      let objSerializedForm = {};
      for (let [name, value] of form_data) {
        if (name === "product") {
          product = value;
        }
        if (name === "value") {
          objSerializedForm[product] = value;
        }
      }

      var request = new XMLHttpRequest();
      request.onreadystatechange = function() {
        if (request.readyState == 4) {
          if(request.status == 200) {
            var element = document.getElementsByClassName("alert-success")[0];
            element.classList.remove("hidden");
            isSubmittedToday = true;
          } else {
            var element = document.getElementsByClassName("alert-danger")[0];
            element.classList.remove("hidden");
          }
          window.scrollTo(0, 0);
        }
      }
      request.open('POST', '/inventory/');
      request.setRequestHeader("X-CSRFToken", csrftoken); 
      request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      request.send(JSON.stringify(objSerializedForm));

    }

    document.addEventListener("DOMContentLoaded", function() {

      var submitInventoryModal = new bootstrap.Modal(document.getElementById("submitInventoryModal"), {});

      document.getElementById('confirmSubmit').onclick = function() {
        submitForm();
        submitInventoryModal.hide();
      }

      document.getElementById('form').onsubmit = function (evt) {
      
        evt.preventDefault();

        if (isSubmittedToday) {
          submitInventoryModal.show();
        } else {
          submitForm();
        }

      }

    });
  </script>


{% endblock %}